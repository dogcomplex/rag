<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GraphRAG Dashboard</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 0; }
    header { padding: 12px 16px; background: #111; color: #fff; display: flex; align-items: center; gap: 12px; }
    header h1 { margin: 0; font-size: 16px; font-weight: 600; }
    main { padding: 16px; display: grid; grid-template-columns: 320px 1fr; gap: 16px; }
    .panel { border: 1px solid #ddd; border-radius: 8px; padding: 12px; background: #fafafa; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 8px; }
    .btn { padding: 6px 10px; border: 1px solid #ccc; border-radius: 6px; background: #fff; cursor: pointer; }
    .btn.primary { background: #2563eb; color: #fff; border-color: #2563eb; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 6px 8px; border-bottom: 1px solid #eee; text-align: left; font-size: 13px; }
    h3 { margin: 0 0 8px 0; font-size: 14px; }
    small { color: #666; }
    ul { margin: 6px 0 0 18px; }
    .badge { background:#eee; padding:2px 6px; border-radius:10px; font-size:11px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .ok { color: #15803d; }
    .err { color: #b91c1c; }
  </style>
</head>
<body>
  <header>
    <h1>GraphRAG Dashboard</h1>
    <button class="btn" onclick="refresh()">Refresh</button>
  </header>
  <main>
    <section class="panel" id="controls">
      <h3>Planner</h3>
      <div class="row" style="margin-bottom:8px;">
        <label>Plugins</label>
        <select id="plugins" multiple size="8" style="width:100%">
          <option value="summaries">summaries</option>
          <option value="summary-20w">summary-20w</option>
          <option value="topic-tags">topic-tags</option>
          <option value="keyphrases">keyphrases</option>
          <option value="glossary">glossary</option>
          <option value="requirements">requirements</option>
          <option value="todo-items">todo-items</option>
          <option value="faq-pairs">faq-pairs</option>
          <option value="bridge-candidates">bridge-candidates</option>
          <option value="risk-scan">risk-scan</option>
          <option value="recent-summary">recent-summary</option>
          <option value="pii-scan">pii-scan</option>
        </select>
      </div>
      <div class="row" style="margin-bottom:8px;">
        <label>Summaries modes</label>
        <input id="sum_modes" value="short,medium" style="flex:1" />
      </div>
      <div class="row" style="margin-bottom:8px;">
        <label>Changed since (min)</label>
        <input id="changed_min" type="number" min="0" value="0" style="width:100px" />
        <label>Limit</label>
        <input id="limit" type="number" min="0" value="0" style="width:100px" />
      </div>
      <div class="row">
        <label><input id="only_missing" type="checkbox" checked /> only-missing</label>
        <button class="btn primary" onclick="planEnqueue()">Plan + Enqueue</button>
      </div>

      <hr/>
      <h3>Direct Enqueue</h3>
      <div class="row" style="margin-bottom:8px;">
        <input id="doc_ids" placeholder="doc ids comma-separated (leave empty = all)" style="flex:1" />
      </div>
      <div class="row">
        <button class="btn" onclick="enqueueSelected()">Enqueue for selected plugins</button>
      </div>
      <hr/>
      <h3>Worker</h3>
      <div class="row" style="margin-bottom:8px;">
        <input id="worker_plugins" value="summaries,keyphrases,bridge-candidates,risk-scan,recent-summary" style="flex:1" />
        <label>batch</label>
        <input id="worker_batch" type="number" value="32" style="width:90px" />
      </div>
      <div class="row">
        <button class="btn" onclick="startWorker()">Start Worker</button>
        <button class="btn" onclick="stopWorker()">Stop Worker</button>
      </div>
    </section>

    <section class="panel" id="status">
      <h3>Status</h3>
      <div id="llm"></div>
      <div class="grid" id="queue"></div>
      <div class="row" style="justify-content:space-between;align-items:center;">
        <h3>Attributes Coverage</h3>
        <div><label><input id="auto_refresh" type="checkbox" checked /> auto-refresh</label>
        <select id="refresh_sec"><option>3</option><option selected>5</option><option>10</option><option>30</option></select></div>
      </div>
      <div id="coverage"></div>
      <h3 style="margin-top:16px;">Domains</h3>
      <div id="domains"></div>
      <h3 style="margin-top:16px;">Worker Log (tail)</h3>
      <pre id="worker_log" style="background:#111;color:#ddd;padding:8px;border-radius:6px;max-height:200px;overflow:auto;"></pre>
    </section>
  </main>

  <script>
    async function refresh(){
      const r = await fetch('/api/status');
      const data = await r.json();
      render(data);
    }
    function selValues(id){
      const s = document.getElementById(id);
      return Array.from(s.selectedOptions).map(o=>o.value);
    }
    async function planEnqueue(){
      const plugins = selValues('plugins');
      const payload = {
        plugins,
        only_missing: document.getElementById('only_missing').checked,
        changed_since_min: parseInt(document.getElementById('changed_min').value||'0'),
        limit: parseInt(document.getElementById('limit').value||'0'),
        summaries_modes: (document.getElementById('sum_modes').value||'').split(',').map(s=>s.trim()).filter(Boolean)
      };
      await fetch('/api/plan', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      await refresh();
    }
    async function enqueueSelected(){
      const plugins = selValues('plugins');
      let doc_ids = (document.getElementById('doc_ids').value||'').split(',').map(s=>s.trim()).filter(Boolean);
      if(doc_ids.length === 0){
        // request doc_ids via status coverage keys
        const r = await fetch('/api/status');
        const data = await r.json();
        // fallback: we cannot list doc ids from status; backend API expects explicit ids
        alert('Provide doc_ids (comma-separated) to enqueue directly.');
        return;
      }
      await fetch('/api/enqueue', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({plugins, doc_ids})});
      await refresh();
    }
    async function startWorker(){
      const plugins = (document.getElementById('worker_plugins').value||'').split(',').map(s=>s.trim()).filter(Boolean);
      const batch = parseInt(document.getElementById('worker_batch').value||'32');
      await fetch('/api/worker/start', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({plugins, batch})});
      await refresh();
    }
    async function stopWorker(){
      await fetch('/api/worker/stop', {method:'POST'});
      await refresh();
    }
    function render(data){
      const llm = document.getElementById('llm');
      llm.innerHTML = `<div>LLM: <span class="${data.llm.reachable?'ok':'err'}">${data.llm.reachable?'reachable':'unreachable'}</span> <span class="mono">${data.llm.endpoint}</span></div>`
        + (data.llm.models && data.llm.models.length? `<div><small>models: ${data.llm.models.join(', ')}</small></div>`: '');

      const q = data.queue||{};
      const qdiv = document.getElementById('queue');
      const rows = [];
      rows.push(`<div class="panel"><div><b>Total</b>: ${q.total||0}</div><div>by_status: ${JSON.stringify(q.by_status||{})}</div><div>oldest_pending_min: ${q.oldest_pending_min??'n/a'}</div></div>`);
      const bp = q.by_plugin_status||{};
      Object.keys(bp).sort().forEach(k=>{
        rows.push(`<div class="panel"><div><b>${k}</b></div><div><small>${JSON.stringify(bp[k])}</small></div></div>`);
      });
      qdiv.innerHTML = rows.join('');

      const cov = data.attributes_coverage||{};
      const covDiv = document.getElementById('coverage');
      const covRows = ['<table><thead><tr><th>Attribute</th><th>Have/Total</th><th>pct</th><th>Missing (examples)</th></tr></thead><tbody>'];
      Object.keys(cov).sort().forEach(k=>{
        const v = cov[k];
        covRows.push(`<tr><td>${k}</td><td>${v.have}/${v.total_docs}</td><td>${v.pct}%</td><td>${(v.missing_examples||[]).join(', ')}</td></tr>`);
      });
      covRows.push('</tbody></table>');
      covDiv.innerHTML = covRows.join('');

      const domDiv = document.getElementById('domains');
      const d = data.domains||[];
      domDiv.innerHTML = '<ul>' + d.map(x=>`<li>${x.domain} <span class="badge">${x.docs}</span></li>`).join('') + '</ul>';

      const w = data.worker||{};
      const log = (w.log_tail||[]).join('\n');
      document.getElementById('worker_log').textContent = (w.running? '[running]\n' : '[stopped]\n') + log;
    }
    refresh();
    setInterval(()=>{
      const on = document.getElementById('auto_refresh').checked;
      const sec = parseInt(document.getElementById('refresh_sec').value||'5');
      if(on){ refresh(); }
    }, 5000);
  </script>
</body>
</html>

