<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GraphRAG Dashboard</title>
  <style>
    :root {
      --bg: #0b111b;
      --header-bg: #0f172a;
      --panel: #161f2e;
      --panel-alt: #1e2737;
      --border: #263342;
      --text: #e6edf7;
      --subtle: #94a3b8;
      --accent: #3b82f6;
      --accent-strong: #60a5fa;
      --danger: #f87171;
      --success: #34d399;
      --input-bg: #0f172a;
      --input-border: #1f2937;
      --table-row: #101827;
      --table-row-alt: #141d2c;
    }
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--text); }
    header { padding: 12px 16px; background: var(--header-bg); color: var(--text); display: flex; align-items: center; gap: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    header h1 { margin: 0; font-size: 16px; font-weight: 600; }
    main { padding: 16px; display: grid; grid-template-columns: 320px 1fr; gap: 16px; }
    .panel { border: 1px solid var(--border); border-radius: 8px; padding: 12px; background: var(--panel); box-shadow: 0 2px 12px rgba(0,0,0,0.25); }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 8px; }
    .btn { padding: 6px 10px; border: 1px solid var(--input-border); border-radius: 6px; background: var(--input-bg); color: var(--text); cursor: pointer; transition: background 0.15s ease, border-color 0.15s ease; }
    .btn.small { padding: 4px 6px; font-size: 12px; }
    .btn:hover { background: var(--panel-alt); border-color: var(--accent); }
    .btn.primary { background: var(--accent); color: #0b1220; border-color: var(--accent); }
    .btn.primary:hover { background: var(--accent-strong); border-color: var(--accent-strong); }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 6px 8px; border-bottom: 1px solid rgba(148, 163, 184, 0.2); text-align: left; font-size: 13px; }
    thead th { color: var(--subtle); font-weight: 500; text-transform: uppercase; letter-spacing: 0.02em; background: rgba(15, 23, 42, 0.6); }
    tbody tr { background: var(--table-row); }
    tbody tr:nth-child(2n) { background: var(--table-row-alt); }
    h3 { margin: 0 0 8px 0; font-size: 14px; color: var(--text); }
    small { color: var(--subtle); }
    ul { margin: 6px 0 0 18px; }
    .badge { background: rgba(59, 130, 246, 0.2); color: var(--accent-strong); padding:2px 6px; border-radius:10px; font-size:11px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .ok { color: var(--success); }
    .err { color: var(--danger); }
    input, select, textarea { background: var(--input-bg); color: var(--text); border: 1px solid var(--input-border); border-radius: 6px; padding: 4px 6px; }
    input::placeholder, textarea::placeholder { color: rgba(148, 163, 184, 0.6); }
    details { background: var(--panel-alt); border-radius: 8px; border: 1px solid var(--border); padding: 8px; }
    details summary { cursor: pointer; color: var(--text); }
    pre { background: var(--panel-alt); color: var(--text); border-radius: 6px; padding: 8px; }
    select { min-height: 28px; }
    option { background: var(--input-bg); color: var(--text); }
    select option[selected], select option:checked {
      background-color: rgba(148, 163, 184, 0.28) !important;
      color: var(--text) !important;
    }
    select:focus option[selected], select:focus option:checked {
      background-color: rgba(59, 130, 246, 0.45) !important;
      color: var(--text) !important;
    }
    a { color: var(--accent-strong); }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <header>
    <h1>GraphRAG Dashboard</h1>
    <button class="btn" onclick="refresh()">Refresh</button>
  </header>
  <main>
    <section class="panel" id="controls">
      <h3>Planner</h3>
      <div class="row" style="margin-bottom:4px; align-items:center;">
        <label>Plugins</label>
        <span style="flex:1"></span>
        <div class="row" style="gap:4px;">
          <button class="btn" type="button" onclick="multiSelectAll('plugins')">All</button>
          <button class="btn" type="button" onclick="multiSelectNone('plugins')">None</button>
        </div>
      </div>
      <div class="row" style="margin-bottom:8px;">
        <select id="plugins" multiple size="10" style="width:100%">
          <option value="multi-basic">multi-basic (batch)</option>
          <option value="doc-skeleton">doc-skeleton</option>
          <option value="summary-20w">summary-20w</option>
          <option value="summary-short">summary-short</option>
          <option value="summary-medium">summary-medium</option>
          <option value="summary-long">summary-long</option>
          <option value="summary-outline">summary-outline</option>
          <option value="topic-tags">topic-tags</option>
          <option value="keyphrases">keyphrases</option>
          <option value="glossary">glossary</option>
          <option value="requirements">requirements</option>
          <option value="todo-items">todo-items</option>
          <option value="faq-pairs">faq-pairs</option>
          <option value="bridge-candidates">bridge-candidates</option>
          <option value="risk-scan">risk-scan</option>
          <option value="recent-summary">recent-summary</option>
          <option value="pii-scan">pii-scan</option>
        </select>
      </div>
      <div class="row" style="margin-bottom:4px; align-items:center;">
        <label>Docs</label>
        <span style="flex:1"></span>
        <div class="row" style="gap:4px;">
          <button class="btn" type="button" onclick="multiSelectAll('planner_docs')">All</button>
          <button class="btn" type="button" onclick="multiSelectNone('planner_docs')">None</button>
        </div>
      </div>
      <div class="row" style="margin-bottom:8px;">
        <select id="planner_docs" multiple size="10" style="width:100%"></select>
      </div>
      <div class="row" style="margin-bottom:8px;">
        <label>Payload JSON</label>
        <input id="payload_json" placeholder='{"llm":{"model":"qwen2.5-7b-instruct","timeout":60}}' style="flex:1" />
      </div>
      <div class="row" style="margin-bottom:8px;">
        <label>Changed since (min)</label>
        <input id="changed_min" type="number" min="0" value="0" style="width:100px" />
        <label>Limit</label>
        <input id="limit" type="number" min="0" value="0" style="width:100px" />
        <label><input id="map_reduce" type="checkbox" /> map-reduce</label>
      </div>
      <div class="row">
        <label><input id="only_missing" type="checkbox" checked /> only-missing</label>
        <button class="btn primary" onclick="planEnqueue()">Plan + Enqueue</button>
      </div>

      <hr/>
      <h3>Ingest</h3>
      <div class="row" style="margin-bottom:8px;">
        <input id="ingest_path" placeholder="repo path (e.g., G:\\LOKI\\papers)" style="flex:1" />
        <label><input id="ingest_full" type="checkbox" checked /> full</label>
      </div>
      <div class="row">
        <button class="btn" onclick="startIngest()">Start Ingest</button>
      </div>
      <hr/>
      <h3>Direct Enqueue</h3>
      <div class="row" style="margin-bottom:8px;">
        <input id="doc_ids" placeholder="doc ids comma-separated (leave empty = all)" style="flex:1" />
      </div>
      <div class="row">
        <button class="btn" onclick="enqueueSelected()">Enqueue for selected plugins</button>
      </div>
      <hr/>
      <h3>Worker</h3>
      <div class="row" style="margin-bottom:8px;">
        <input id="worker_plugins" value="*" style="flex:1" />
        <label>batch</label>
        <input id="worker_batch" type="number" value="8" style="width:90px" />
        <label>max-inflight</label>
        <input id="worker_max_inflight" type="number" value="2" style="width:90px" />
      </div>
      <div class="row">
        <button class="btn" onclick="startWorker()">Start Worker</button>
        <button class="btn" onclick="stopWorkerAll()">Stop All</button>
        <button class="btn" onclick="testWorker()">Test Connection</button>
      </div>
      <hr/>
      <h3>Gateway</h3>
      <div class="row" style="margin-bottom:8px;">
        <input id="gateway_service" placeholder="service (default lmstudio)" style="flex:1" />
        <label>log level</label>
        <input id="gateway_loglevel" value="INFO" style="width:90px" />
      </div>
      <div class="row">
        <button class="btn" onclick="startGateway()">Start Gateway</button>
        <button class="btn" onclick="stopGateway()">Stop Gateway</button>
      </div>
      <pre id="gateway_status" class="mono" style="margin-top:8px;background:var(--panel-alt);color:var(--text);padding:8px;border-radius:6px;max-height:160px;overflow:auto;border:1px solid var(--border);"></pre>
      <pre id="worker_test_result" class="mono" style="margin-top:8px;background:var(--panel-alt);color:var(--text);padding:8px;border-radius:6px;max-height:160px;overflow:auto;border:1px solid var(--border);"></pre>
      <div id="workers_list" style="margin-top:8px;"></div>
    </section>

    <section class="panel" id="status">
      <h3>Status</h3>
      <div id="llm"></div>
      <div class="grid" id="queue"></div>
      <details style="margin:8px 0;">
        <summary><b>Plugin defaults</b> <small>(per-plugin model/timeout)</small></summary>
        <div class="row" style="margin:6px 0;">
          <button class="btn" onclick="loadPluginDefaults()">Load</button>
          <span><small>Use JSON: { "summary-short": { "llm": { "model": "qwen2.5-7b-instruct", "timeout": 60 } } }</small></span>
        </div>
        <textarea id="plugin_defaults_json" style="width:100%;height:120px"></textarea>
        <div class="row" style="margin-top:6px;">
          <button class="btn" onclick="savePluginDefaults()">Save</button>
        </div>
      </details>
      <details style="margin:8px 0;">
        <summary><b>Queue listing</b> <small>(ordered by id asc)</small></summary>
      <div class="row" style="margin:6px 0;">
        <label>Status</label>
        <select id="queue_status"><option value="">(any)</option><option>pending</option><option>running</option><option>done</option></select>
        <label>Plugin</label>
        <input id="queue_plugin" placeholder="(any)" />
        <label>Limit</label>
        <input id="queue_limit" type="number" value="200" style="width:90px" />
        <button class="btn" onclick="loadQueueList()">Load</button>
        <span style="flex:1"></span>
        <label>Clear</label>
        <select id="queue_clear_mode"><option value="non-done">non-done</option><option value="pending">pending</option><option value="reset-running">reset running→pending</option><option value="reset-running-counter">reset running→pending + reset counter</option><option value="all">all</option></select>
        <button class="btn" onclick="clearQueue()">Clear Queue</button>
      </div>
        <div id="queue_list" style="max-height:240px; overflow:auto; border:1px solid var(--border); border-radius:6px; padding:6px; background:var(--panel-alt);"></div>
      </details>
      <details style="margin:8px 0;">
        <summary><b>LLM cache</b> <small>(prompt-level)</small></summary>
        <div class="row" style="margin:6px 0;">
          <button class="btn" onclick="loadCacheStats()">Refresh</button>
          <div id="cache_stats" style="margin-left:8px"></div>
          <span style="flex:1"></span>
          <button class="btn" onclick="clearCache()">Clear cache</button>
        </div>
        <div class="row" style="margin:6px 0;">
          <label>Show</label>
          <input id="cache_limit" type="number" value="200" style="width:90px" />
          <button class="btn" onclick="loadCacheList()">List</button>
        </div>
        <div id="cache_list" style="max-height:240px; overflow:auto; border:1px solid var(--border); border-radius:6px; padding:6px; background:var(--panel-alt);"></div>
      </details>
      <details style="margin:8px 0;">
        <summary><b>Failed Jobs</b></summary>
        <button class="btn" onclick="loadFailedJobs()">Refresh Failed</button>
        <div id="failed_jobs" style="margin-top:8px; max-height:200px; overflow:auto; border:1px solid var(--border); border-radius:6px; padding:6px; background:var(--panel-alt);"></div>
      </details>
      <div class="row" style="justify-content:space-between;align-items:center;">
        <h3>Attributes Coverage</h3>
        <div><label><input id="auto_refresh" type="checkbox" checked /> auto-refresh</label>
        <select id="refresh_sec"><option>3</option><option selected>5</option><option>10</option><option>30</option></select></div>
      </div>
      <div id="coverage_overall"></div>
      <div id="coverage"></div>
      <h3 style="margin-top:16px;">Domains</h3>
      <div id="domains"></div>
      <h3 style="margin-top:16px;">Worker Log (tail)</h3>
      <pre id="worker_log" style="background:var(--panel-alt);color:var(--text);padding:8px;border-radius:6px;max-height:200px;overflow:auto;border:1px solid var(--border);"></pre>

      <h3 style="margin-top:16px;">Documents</h3>
      <div class="row" style="margin-bottom:8px;">
        <input id="doc_filter" placeholder="filter by doc_id or domain" oninput="renderDocs()" style="flex:1" />
      </div>
      <div id="docs"></div>
    </section>
  </main>

  <script>
    // coverage open state persists across refreshes
    window.__COV_OPEN__ = window.__COV_OPEN__ || new Set();
    window.__COV_DOC_OPEN__ = window.__COV_DOC_OPEN__ || {}; // plugin -> Set(doc_id)
    window.__COV_DATA__ = window.__COV_DATA__ || {}; // plugin -> {present, missing}
    window.__ATTR_ITEM_CACHE__ = window.__ATTR_ITEM_CACHE__ || {}; // key: plugin|doc -> json
    window.__PLANNER_SELECTED_PLUGINS__ = window.__PLANNER_SELECTED_PLUGINS__ || [];
    window.__PLANNER_SELECTED_DOCS__ = window.__PLANNER_SELECTED_DOCS__ || [];
    window.__RUNNABLE_PLUGINS__ = window.__RUNNABLE_PLUGINS__ || [];
    window.__DOCS_COVERAGE_TOTAL__ = window.__DOCS_COVERAGE_TOTAL__ || 0;

    async function refresh(){
      const r = await fetch('/api/status');
      const data = await r.json();
      render(data);
      populatePlannerDocs();
      ensurePlannerBindings();
      restorePlannerSelections();
    }
    function selValues(id){
      const s = document.getElementById(id);
      return Array.from(s.selectedOptions).map(o=>o.value);
    }
    function rememberSelection(id, key){
      const sel = document.getElementById(id);
      if(!sel){ return; }
      window[key] = Array.from(sel.selectedOptions).map(o=>o.value);
    }
    function applySelection(id, key){
      const sel = document.getElementById(id);
      if(!sel){ return; }
      const desired = new Set(window[key] || []);
      Array.from(sel.options).forEach(opt=>{ opt.selected = desired.has(opt.value); });
    }
    function restorePlannerSelections(){
      applySelection('plugins', '__PLANNER_SELECTED_PLUGINS__');
      applySelection('planner_docs', '__PLANNER_SELECTED_DOCS__');
    }
    function populatePlannerDocs(){
      const select = document.getElementById('planner_docs');
      if(!select){ return; }
      const docs = window.__DOCS__ || [];
      const scroll = select.scrollTop;
      select.innerHTML = '';
      docs.slice().sort((a,b)=>a.doc_id.localeCompare(b.doc_id)).forEach(doc=>{
        const opt = document.createElement('option');
        opt.value = doc.doc_id;
        const domain = doc.domain ? ` (${doc.domain})` : '';
        opt.textContent = `${doc.doc_id}${domain}`;
        select.appendChild(opt);
      });
      applySelection('planner_docs', '__PLANNER_SELECTED_DOCS__');
      select.scrollTop = scroll;
      rememberSelection('planner_docs', '__PLANNER_SELECTED_DOCS__');
    }
    function multiSelectAll(id){
      const sel = document.getElementById(id);
      if(!sel){ return; }
      Array.from(sel.options).forEach(opt=>{ opt.selected = true; });
      rememberSelection(id, id === 'plugins' ? '__PLANNER_SELECTED_PLUGINS__' : '__PLANNER_SELECTED_DOCS__');
      restorePlannerSelections();
    }
    function multiSelectNone(id){
      const sel = document.getElementById(id);
      if(!sel){ return; }
      Array.from(sel.options).forEach(opt=>{ opt.selected = false; });
      rememberSelection(id, id === 'plugins' ? '__PLANNER_SELECTED_PLUGINS__' : '__PLANNER_SELECTED_DOCS__');
      restorePlannerSelections();
    }
    function ensurePlannerBindings(){
      const pluginSel = document.getElementById('plugins');
      if(pluginSel && pluginSel.dataset.plannerBound !== '1'){
        const handler = ()=>rememberSelection('plugins', '__PLANNER_SELECTED_PLUGINS__');
        pluginSel.addEventListener('change', handler);
        pluginSel.addEventListener('input', handler);
        pluginSel.addEventListener('mousedown', evt=>toggleOptionSelection(evt, handler));
        pluginSel.dataset.plannerBound = '1';
        handler();
      }
      const docSel = document.getElementById('planner_docs');
      if(docSel && docSel.dataset.plannerBound !== '1'){
        const handler = ()=>rememberSelection('planner_docs', '__PLANNER_SELECTED_DOCS__');
        docSel.addEventListener('change', handler);
        docSel.addEventListener('input', handler);
        docSel.addEventListener('mousedown', evt=>toggleOptionSelection(evt, handler));
        docSel.dataset.plannerBound = '1';
        handler();
      }
    }
    function toggleOptionSelection(evt, handler){
      const opt = evt.target;
      if(!opt || opt.tagName !== 'OPTION'){ return; }
      evt.preventDefault();
      const sel = opt.parentElement;
      const willSelect = !opt.selected;
      opt.selected = willSelect;
      if(!opt.selected){
        // keep focus on select to allow repeated toggles
        sel.focus();
      }
      handler();
    }
    async function planEnqueue(){
      rememberSelection('plugins', '__PLANNER_SELECTED_PLUGINS__');
      rememberSelection('planner_docs', '__PLANNER_SELECTED_DOCS__');
      const plugins = selValues('plugins');
      const doc_ids = selValues('planner_docs');
      const payload = {
        plugins,
        only_missing: document.getElementById('only_missing').checked,
        changed_since_min: parseInt(document.getElementById('changed_min').value||'0'),
        limit: parseInt(document.getElementById('limit').value||'0'),
        map_reduce: document.getElementById('map_reduce').checked
      };
      const pjson = document.getElementById('payload_json').value||'';
      if(pjson){ payload.payload_json = pjson; }
      if(doc_ids.length){ payload.doc_ids = doc_ids; }
      await fetch('/api/plan', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      await refresh();
    }
    async function enqueueSelected(){
      rememberSelection('plugins', '__PLANNER_SELECTED_PLUGINS__');
      rememberSelection('planner_docs', '__PLANNER_SELECTED_DOCS__');
      const plugins = selValues('plugins');
      let doc_ids = selValues('planner_docs');
      const manual = (document.getElementById('doc_ids').value||'').split(',').map(s=>s.trim()).filter(Boolean);
      doc_ids = Array.from(new Set([...doc_ids, ...manual]));
      if(doc_ids.length === 0){
        alert('Select docs from the Docs list or provide doc_ids (comma-separated).');
        return;
      }
      await fetch('/api/enqueue', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({plugins, doc_ids})});
      await refresh();
    }
    async function startIngest(){
      const repo = document.getElementById('ingest_path').value||'';
      const full = document.getElementById('ingest_full').checked;
      if(!repo){ alert('Enter a repo path'); return; }
      await fetch('/api/ingest', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({repo, full})});
    }
    async function startWorker(){
      const plugins = (document.getElementById('worker_plugins').value||'').split(',').map(s=>s.trim()).filter(Boolean);
      const batch = parseInt(document.getElementById('worker_batch').value||'8');
      const max_inflight = parseInt(document.getElementById('worker_max_inflight').value||'2');
      await fetch('/api/worker/start', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({plugins, batch, max_inflight})});
      await refresh();
    }
    async function stopWorkerAll(){
      await fetch('/api/worker/stop', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({})});
      await refresh();
    }
    async function startGateway(){
      const service = (document.getElementById('gateway_service').value||'').trim();
      const logLevel = (document.getElementById('gateway_loglevel').value||'INFO').trim() || 'INFO';
      const body = { log_level: logLevel };
      if(service){ body.service = service; }
      const r = await fetch('/api/gateway/start', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      const data = await r.json();
      document.getElementById('gateway_status').textContent = JSON.stringify(data, null, 2);
      await refresh();
    }
    async function stopGateway(){
      const r = await fetch('/api/gateway/stop', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({})});
      const data = await r.json();
      document.getElementById('gateway_status').textContent = JSON.stringify(data, null, 2);
      await refresh();
    }
    async function testWorker(){
      const out = document.getElementById('worker_test_result');
      try{
        const r = await fetch('/api/status?force_models=1');
        const txt = await r.text();
        out.textContent = `HTTP ${r.status}\n${txt}`;
        console.log('[worker test]', r.status, txt);
      }catch(err){
        out.textContent = `Request failed: ${err}`;
        console.error('[worker test] error', err);
      }
    }
    function render(data){
      const llm = document.getElementById('llm');
      llm.innerHTML = `<div>LLM: <span class="${data.llm.reachable?'ok':'err'}">${data.llm.reachable?'reachable':'unreachable'}</span> <span class="mono">${data.llm.endpoint}</span></div>`
        + (data.llm.models && data.llm.models.length? `<div><small>models: ${data.llm.models.join(', ')}</small></div>`: '');
      if(data.llm.error){ llm.innerHTML += `<div class="err"><small>${data.llm.error}</small></div>`; }

      const gatewayEl = document.getElementById('gateway_status');
      if(gatewayEl && data.gateway){
        gatewayEl.textContent = JSON.stringify(data.gateway, null, 2);
      }

      const q = data.queue||{};
      const qdiv = document.getElementById('queue');
      const rows = [];
      const thr = q.throughput||{};
      const eta = q.eta||{};
      const overallEta = eta.overall_sec != null ? `, ETA: ${fmtDur(eta.overall_sec)}` : '';
      rows.push(`<div class="panel"><div><b>Total</b>: ${q.total||0}${overallEta}</div><div>by_status: ${JSON.stringify(q.by_status||{})}</div><div>oldest_pending_min: ${q.oldest_pending_min??'n/a'}</div><div><small>throughput: overall ${thr.overall_dps||0}/s over ${thr.window_min||0}m</small></div></div>`);
      const bp = q.by_plugin_status||{};
      const dur = q.durations||{};
      Object.keys(bp).sort().forEach(k=>{
        const d = dur[k];
        const est = d? `, avg ${d.avg_s}s over ${d.n}` : '';
        let etaPlug = '';
        if(eta.plugin_sec && eta.plugin_sec[k] != null){ etaPlug = `, ETA ${fmtDur(eta.plugin_sec[k])}`; }
        let dps = '';
        if(thr.plugin_dps && thr.plugin_dps[k] != null){ dps = `, ${thr.plugin_dps[k]}/s`; }
        rows.push(`<div class="panel"><div><b>${k}</b>${est}${dps}${etaPlug}</div><div><small>${JSON.stringify(bp[k])}</small></div></div>`);
      });
      qdiv.innerHTML = rows.join('');
      // refresh queue list silently if already populated
      if(document.getElementById('queue_list').getAttribute('data-has')==='1'){
        loadQueueList(true);
      }
      // auto refresh plugin defaults snapshot
      // (non-intrusive; we only auto-load once)
      if(!window.__PLUGINS_LOADED__){ loadPluginDefaults(); window.__PLUGINS_LOADED__=true; }

      renderCoverage(data);

      const domDiv = document.getElementById('domains');
      const d = data.domains||[];
      domDiv.innerHTML = '<ul>' + d.map(x=>`<li>${x.domain} <span class="badge">${x.docs}</span></li>`).join('') + '</ul>';

      const w = data.worker||{};
      const log = (w.log_tail||[]).join('\n');
      const statusPrefix = w.running ? '[running]\n' : '[stopped]\n';
      document.getElementById('worker_log').textContent = statusPrefix + log;
      renderWorkers(data.workers||[]);

      window.__STATUS__ = data;
      if(!window.__DOCS__){ loadDocs(); }
    }
    refresh();
    setInterval(()=>{
      const on = document.getElementById('auto_refresh').checked;
      const sec = parseInt(document.getElementById('refresh_sec').value||'5');
      if(on){ refresh(); }
    }, 5000);
    function fmtDur(sec){
      sec = Math.max(0, Math.round(sec));
      const h = Math.floor(sec/3600); const m = Math.floor((sec%3600)/60); const s = sec%60;
      return (h>0? h+'h ': '') + (m>0? m+'m ': '') + s + 's';
    }
    function renderWorkers(list){
      const root = document.getElementById('workers_list');
      if(!list || !list.length){ root.innerHTML = '<small>No workers</small>'; return; }
      root.innerHTML = '<div style="overflow-x:auto;">' +
        '<table style="min-width:820px;"><thead><tr><th>Current</th><th>ID</th><th>PID</th><th>Plugins</th><th>Batch</th><th>Started</th><th>Status</th><th></th></tr></thead><tbody>'+
        list.map(w=>`<tr><td><small class="mono" style="white-space:pre-wrap;">${w.current?fmtCurrent(w.current):''}</small></td><td>${w.id}</td><td>${w.pid||''}</td><td><small>${(w.plugins||[]).join(', ')}</small></td><td>${w.batch||''}</td><td><small>${w.started_at||''}</small></td><td>${w.running?'running':'stopped'}</td><td><button class=btn onclick="stopWorker(${w.id})">Stop</button></td></tr>`).join('')+
        '</tbody></table></div>';
    }
    function fmtCurrent(cur){
      if(!cur) return '';
      const parts = [];
      if(cur.plugin) parts.push(`plugin=${cur.plugin}`);
      if(cur.docs){
        const docs = cur.docs.length > 80 ? cur.docs.slice(0,77) + '…' : cur.docs;
        parts.push(`docs=${docs}`);
      }
      if(cur.since) parts.push(`since ${cur.since}`);
      return parts.map(p=>`• ${p}`).join('\n');
    }
    async function stopWorker(id){
      await fetch('/api/worker/stop', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id})});
      await refresh();
    }
    async function loadQueueList(silent){
      const status = document.getElementById('queue_status').value;
      const plugin = document.getElementById('queue_plugin').value;
      const limit = parseInt(document.getElementById('queue_limit').value||'200');
      const params = new URLSearchParams();
      if(status) params.set('status', status);
      if(plugin) params.set('plugin', plugin);
      if(limit) params.set('limit', String(limit));
      const r = await fetch('/api/queue/list?' + params.toString());
      console.debug('[queue-list] status', r.status);
      const data = await r.json();
      const items = data.items||[];
      const root = document.getElementById('queue_list');
      root.setAttribute('data-has','1');
      root.innerHTML = '<table><thead><tr><th>ID</th><th>Status</th><th>Plugin</th><th>Doc</th><th>Created</th></tr></thead><tbody>'
        + items.map(i=>`<tr><td>${i.id}</td><td>${i.status}</td><td>${i.plugin}</td><td>${i.doc_id}</td><td>${i.created_at||''}</td></tr>`).join('')
        + '</tbody></table>';
    }
    async function clearQueue(){
      const mode = document.getElementById('queue_clear_mode').value||'non-done';
      console.debug('[queue-clear] mode', mode);
      await fetch('/api/queue/clear', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({mode})});
      await loadQueueList(true);
      await refresh();
    }
    async function loadPluginDefaults(){
      document.getElementById('plugin_defaults_json').value = 'Not supported on this build.';
    }
    async function savePluginDefaults(){
      alert('Saving plugin defaults is disabled in this build.');
    }
    async function loadCacheStats(){
      const r = await fetch('/api/cache/llm/stats');
      const data = await r.json();
      document.getElementById('cache_stats').innerText = `entries: ${data.count||0}, size: ${data.total_bytes||0} bytes`;
    }
    async function loadCacheList(){
      const limit = parseInt(document.getElementById('cache_limit').value||'200');
      const r = await fetch('/api/cache/llm/list?limit=' + limit);
      const data = await r.json();
      const items = data.items||[];
      document.getElementById('cache_list').innerHTML = '<table><thead><tr><th>Name</th><th>Size</th><th>MTime</th></tr></thead><tbody>' +
        items.map(i=>`<tr><td>${i.name}</td><td>${i.size}</td><td>${i.mtime}</td></tr>`).join('') + '</tbody></table>';
    }
    async function clearCache(){
      await fetch('/api/cache/llm/clear', {method:'POST'});
      await loadCacheStats();
      document.getElementById('cache_list').innerHTML='';
    }
    function renderCoverage(data){
      const cov = data.attributes_coverage||{};
      const covDiv = document.getElementById('coverage');
      const bp2 = (data.queue||{}).by_plugin_status||{};
      const dur2 = (data.queue||{}).durations||{};
      const thr2 = (data.queue||{}).throughput||{};
      const eta2 = (data.queue||{}).eta||{};
      const overallEtaTxt = (eta2 && eta2.overall_sec!=null) ? `Overall ETA: ${fmtDur(eta2.overall_sec)}` : '';
      document.getElementById('coverage_overall').innerHTML = overallEtaTxt? `<small>${overallEtaTxt}</small>` : '';
      const rows = ['<table><thead><tr><th></th><th>Attribute</th><th>Have/Total</th><th>pct</th><th>Pending</th><th>Running</th><th>Failed</th><th>Avg s</th><th>DPS</th><th>ETA</th><th>Missing (examples)</th></tr></thead><tbody>'];
      const plugins = Object.keys(cov).sort();
      for(const k of plugins){
        const v = cov[k];
        const st = bp2[k]||{}; const d = dur2[k];
        const dps = (thr2.plugin_dps||{})[k];
        const etaS = (eta2.plugin_sec||{})[k];
        const isOpen = window.__COV_OPEN__.has(k);
        rows.push(`<tr onclick="toggleCov('${k}')" style="cursor:pointer;">`
          + `<td style="width:18px;"><span id="cov_arrow_${k}">${isOpen?'▾':'›'}</span></td>`
          + `<td>${k}</td>`
          + `<td>${v.have}/${v.total_docs}</td>`
          + `<td>${v.pct}%</td>`
          + `<td>${st.pending||0}</td>`
          + `<td>${st.running||0}</td>`
          + `<td>${st.failed||0}</td>`
          + `<td>${st.failed||0}</td>`
          + `<td>${d? d.avg_s: ''}</td>`
          + `<td>${dps!=null? dps: ''}</td>`
          + `<td>${etaS!=null? fmtDur(etaS): ''}</td>`
          + `<td>${(v.missing_examples||[]).join(', ')}</td>`
          + `</tr>`);
        // doc rows
        if(isOpen){
          const pdata = window.__COV_DATA__[k];
          const present = (pdata && pdata.present) ? pdata.present : [];
          for(const item of present){
            const doc_id = item.doc_id; const prev = item.preview||'';
            const docOpen = (window.__COV_DOC_OPEN__[k]||new Set()).has(doc_id);
            rows.push(`<tr onclick="toggleCovDoc(event,'${k}','${doc_id}')" style="cursor:pointer;">`
              + `<td></td>`
              + `<td colspan=2><span id="cov_doc_arrow_${k}_${doc_id}">${docOpen?'▾':'›'}</span> <b>${doc_id}</b></td>`
              + `<td colspan=8 style="color:#555;">${escapeHtml(prev)}</td>`
              + `</tr>`);
            const key = `${k}|${doc_id}`;
            const hasFull = window.__ATTR_ITEM_CACHE__[key] != null;
            rows.push(`<tr id="cov_full_${k}_${doc_id}" style="display:${docOpen?'':'none'};"><td></td><td colspan=10><pre style="white-space:pre-wrap;background:var(--panel-alt);padding:8px;border-radius:6px;border:1px solid var(--border);" id="cov_pre_${k}_${doc_id}">${hasFull? escapeHtml(JSON.stringify(window.__ATTR_ITEM_CACHE__[key], null, 2)) : ''}</pre></td></tr>`);
          }
        }
      }
      rows.push('</tbody></table>');
      covDiv.innerHTML = rows.join('');
    }
    async function toggleCov(plugin){
      if(window.__COV_OPEN__.has(plugin)){
        window.__COV_OPEN__.delete(plugin);
        renderCoverage(window.__STATUS__);
        return;
      }
      // open
      window.__COV_OPEN__.add(plugin);
      if(!window.__COV_DATA__[plugin]){
        const r = await fetch(`/api/attr/${plugin}/docs`);
        const data = await r.json();
        window.__COV_DATA__[plugin] = data;
      }
      renderCoverage(window.__STATUS__);
    }
    async function toggleCovDoc(evt, plugin, doc_id){
      evt.stopPropagation();
      const set = (window.__COV_DOC_OPEN__[plugin] = window.__COV_DOC_OPEN__[plugin] || new Set());
      const key = `${plugin}|${doc_id}`;
      if(set.has(doc_id)){
        set.delete(doc_id);
        const row = document.getElementById(`cov_full_${plugin}_${doc_id}`);
        const arrow = document.getElementById(`cov_doc_arrow_${plugin}_${doc_id}`);
        if(row){ row.style.display = 'none'; }
        if(arrow){ arrow.textContent = '›'; }
        return;
      }
      set.add(doc_id);
      // ensure content
      if(window.__ATTR_ITEM_CACHE__[key] == null){
        const r = await fetch(`/api/doc/${doc_id}/attr/${plugin}`);
        const data = await r.json();
        window.__ATTR_ITEM_CACHE__[key] = (data.item||data);
      }
      const pre = document.getElementById(`cov_pre_${plugin}_${doc_id}`);
      const row = document.getElementById(`cov_full_${plugin}_${doc_id}`);
      const arrow = document.getElementById(`cov_doc_arrow_${plugin}_${doc_id}`);
      if(pre){ pre.textContent = JSON.stringify(window.__ATTR_ITEM_CACHE__[key], null, 2); }
      if(row){ row.style.display = ''; }
      if(arrow){ arrow.textContent = '▾'; }
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    }
  </script>
  <script>
    // persist open state for docs and per-doc attributes
    window.__DOC_OPEN__ = window.__DOC_OPEN__ || new Set();
    window.__DOC_ATTR_OPEN__ = window.__DOC_ATTR_OPEN__ || {}; // doc_id -> Set(plugin)
    window.__DOC_META__ = window.__DOC_META__ || {}; // doc_id -> {meta, attributes}
    window.__DOC_CHUNK_ATTR_OPEN__ = window.__DOC_CHUNK_ATTR_OPEN__ || {}; // doc_id -> Set(chunk-plugin)
    window.__CHUNK_ATTR_CACHE__ = window.__CHUNK_ATTR_CACHE__ || {}; // key: chunks|plugin|doc_id -> items

    async function loadDocs(){
      const r = await fetch('/api/docs');
      const data = await r.json();
      window.__DOCS__ = data.docs||[];
      window.__DOCS_COVERAGE_TOTAL__ = data.coverage_total || 0;
      window.__RUNNABLE_PLUGINS__ = data.runnable_plugins || window.__RUNNABLE_PLUGINS__;
      renderDocs();
      populatePlannerDocs();
      restorePlannerSelections();
    }
    function renderDocs(){
      const docs = (window.__DOCS__||[]).slice();
      const q = (document.getElementById('doc_filter').value||'').toLowerCase();
      const root = document.getElementById('docs');
      const total = window.__DOCS_COVERAGE_TOTAL__ || (window.__RUNNABLE_PLUGINS__||[]).length;
      const rows = ['<table><thead><tr><th></th><th>Doc ID</th><th style="width:120px;">Coverage</th><th>Domain</th><th>Path</th></tr></thead><tbody>'];
      docs.filter(d=>!q || d.doc_id.toLowerCase().includes(q) || (d.domain||'').toLowerCase().includes(q))
          .forEach(d=>{
        const open = window.__DOC_OPEN__.has(d.doc_id);
        const have = d.coverage ? (d.coverage.have||0) : 0;
        const tot = d.coverage ? (d.coverage.total||total) : total;
        const pct = tot ? Math.round((have/tot)*100) : 0;
        rows.push(`<tr onclick="toggleDoc('${d.doc_id}')" style="cursor:pointer;">`
          + `<td style="width:18px;"><span id="doc_arrow_${d.doc_id}">${open?'▾':'›'}</span></td>`
          + `<td><b>${d.doc_id}</b></td>`
          + `<td><small>${pct}% (${have}/${tot})</small></td>`
          + `<td><small>${d.domain||''}</small></td>`
          + `<td><span class=mono>${d.path||''}</span></td>`
          + `</tr>`);
        if(open){
          const meta = window.__DOC_META__[d.doc_id];
          const attrs = meta && meta.attributes ? meta.attributes : {};
          const plugs = Object.keys(attrs).sort();
          rows.push(`<tr><td></td><td colspan=4><div class="row" style="gap:6px;">
            <button class="btn small" onclick="event.stopPropagation(); enqueueDocAll('${d.doc_id}', false);">All</button>
            <button class="btn small" onclick="event.stopPropagation(); enqueueDocAll('${d.doc_id}', true);">All (Force)</button>
          </div></td></tr>`);
          for(const plug of plugs){
            const attrOpen = (window.__DOC_ATTR_OPEN__[d.doc_id]||new Set()).has(plug);
            const metaInfo = attrs[plug] || {};
            const runnable = metaInfo.runnable !== false;
            rows.push(`<tr onclick="toggleDocAttr(event,'${d.doc_id}','${plug}')" style="cursor:pointer;">`
              + `<td></td>`
              + `<td colspan=2><span id="doc_attr_arrow_${d.doc_id}_${plug}">${attrOpen?'▾':'›'}</span> ${plug}</td>`
              + `<td colspan=2><div class="row" style="justify-content:flex-end; gap:4px;">
                    <button class="btn small" ${runnable?'':'disabled'} onclick="event.stopPropagation(); enqueueDocAttr('${d.doc_id}','${plug}', false);">Run</button>
                    <button class="btn small" ${runnable?'':'disabled'} onclick="event.stopPropagation(); enqueueDocAttr('${d.doc_id}','${plug}', true);">Run (Force)</button>
                  </div></td>`
              + `</tr>`);
            rows.push(`<tr id="doc_attr_full_${d.doc_id}_${plug}" style="display:${attrOpen?'':'none'};"><td></td><td colspan=4><pre style="white-space:pre-wrap;background:var(--panel-alt);padding:8px;border-radius:6px;border:1px solid var(--border);" id="doc_attr_pre_${d.doc_id}_${plug}"></pre></td></tr>`);
          }
          // Chunk-level attributes (currently exposing chunk-summary)
          const cplug = 'chunk-summary';
          const cOpen = (window.__DOC_CHUNK_ATTR_OPEN__[d.doc_id]||new Set()).has(cplug);
          rows.push(`<tr onclick="toggleDocChunkAttr(event,'${d.doc_id}','${cplug}')" style="cursor:pointer;">`
            + `<td></td>`
            + `<td colspan=2><span id="doc_chunk_attr_arrow_${d.doc_id}_${cplug}">${cOpen?'▾':'›'}</span> ${cplug} <span style="opacity:.65;">(per-chunk)</span></td>`
            + `<td colspan=2></td>`
            + `</tr>`);
          rows.push(`<tr id="doc_chunk_attr_full_${d.doc_id}_${cplug}" style="display:${cOpen?'':'none'};"><td></td><td colspan=4><div style="background:var(--panel-alt);padding:8px;border-radius:6px;max-height:260px;overflow:auto;border:1px solid var(--border);" id="doc_chunk_attr_div_${d.doc_id}_${cplug}"></div></td></tr>`);
        }
      });
      rows.push('</tbody></table>');
      root.innerHTML = rows.join('');
    }
    async function toggleDoc(doc_id){
      if(window.__DOC_OPEN__.has(doc_id)){
        window.__DOC_OPEN__.delete(doc_id);
        renderDocs();
        return;
      }
      window.__DOC_OPEN__.add(doc_id);
      if(!window.__DOC_META__[doc_id]){
        const r = await fetch(`/api/doc/${doc_id}`);
        const data = await r.json();
        window.__DOC_META__[doc_id] = data;
      }
      renderDocs();
    }
    async function toggleDocAttr(evt, doc_id, plug){
      evt.stopPropagation();
      const set = (window.__DOC_ATTR_OPEN__[doc_id] = window.__DOC_ATTR_OPEN__[doc_id] || new Set());
      const key = `${plug}|${doc_id}`;
      if(set.has(plug)){
        set.delete(plug);
        const row = document.getElementById(`doc_attr_full_${doc_id}_${plug}`);
        const arrow = document.getElementById(`doc_attr_arrow_${doc_id}_${plug}`);
        if(row){ row.style.display = 'none'; }
        if(arrow){ arrow.textContent = '›'; }
        return;
      }
      set.add(plug);
      // fetch content if not cached
      if(window.__ATTR_ITEM_CACHE__[key] == null){
        const r = await fetch(`/api/doc/${doc_id}/attr/${plug}`);
        const data = await r.json();
        window.__ATTR_ITEM_CACHE__[key] = (data.item||data);
      }
      const pre = document.getElementById(`doc_attr_pre_${doc_id}_${plug}`);
      const row = document.getElementById(`doc_attr_full_${doc_id}_${plug}`);
      const arrow = document.getElementById(`doc_attr_arrow_${doc_id}_${plug}`);
      if(pre){ pre.textContent = JSON.stringify(window.__ATTR_ITEM_CACHE__[key], null, 2); }
      if(row){ row.style.display = ''; }
      if(arrow){ arrow.textContent = '▾'; }
    }

    async function toggleDocChunkAttr(evt, doc_id, plug){
      evt.stopPropagation();
      const set = (window.__DOC_CHUNK_ATTR_OPEN__[doc_id] = window.__DOC_CHUNK_ATTR_OPEN__[doc_id] || new Set());
      const key = `chunks|${plug}|${doc_id}`;
      if(set.has(plug)){
        set.delete(plug);
        const row = document.getElementById(`doc_chunk_attr_full_${doc_id}_${plug}`);
        const arrow = document.getElementById(`doc_chunk_attr_arrow_${doc_id}_${plug}`);
        if(row){ row.style.display = 'none'; }
        if(arrow){ arrow.textContent = '›'; }
        return;
      }
      set.add(plug);
      if(window.__CHUNK_ATTR_CACHE__[key] == null){
        const r = await fetch(`/api/doc/${doc_id}/chunks/attr/${plug}`);
        const data = await r.json();
        window.__CHUNK_ATTR_CACHE__[key] = (data.items||[]);
      }
      const items = window.__CHUNK_ATTR_CACHE__[key] || [];
      const div = document.getElementById(`doc_chunk_attr_div_${doc_id}_${plug}`);
      const row = document.getElementById(`doc_chunk_attr_full_${doc_id}_${plug}`);
      const arrow = document.getElementById(`doc_chunk_attr_arrow_${doc_id}_${plug}`);
      if(div){
        if(items.length === 0){
          div.innerHTML = '<em style="opacity:.75;">No items</em>';
        } else {
          const lines = ['<table style="width:100%;"><thead><tr><th style="width:64px;">Seq</th><th style="width:320px;">Chunk</th><th>Preview</th></tr></thead><tbody>'];
          for(const it of items){
            const seq = (it.seq == null ? '' : it.seq);
            const chunk = it.chunk_id || '';
            const prev = escapeHtml(it.preview||'');
            lines.push(`<tr><td class=mono>${seq}</td><td class=mono style="word-break:break-all;">${chunk}</td><td>${prev}</td></tr>`);
          }
          lines.push('</tbody></table>');
          div.innerHTML = lines.join('');
        }
      }
      if(row){ row.style.display = ''; }
      if(arrow){ arrow.textContent = '▾'; }
    }
    async function enqueueDocAttr(doc_id, plugin, force){
      const meta = window.__DOC_META__[doc_id];
      const attrs = meta && meta.attributes ? meta.attributes : {};
      const info = attrs[plugin];
      if(!info || info.runnable === false){
        alert(`Plugin ${plugin} is not runnable from dashboard.`);
        return;
      }
      const payload = force ? { overwrite: true, force: true } : { force: true };
      await fetch('/api/enqueue', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({doc_ids:[doc_id], plugins:[plugin], payload})
      });
      await refresh();
    }
    async function enqueueDocAll(doc_id, force){
      const meta = window.__DOC_META__[doc_id];
      const attrs = meta && meta.attributes ? meta.attributes : {};
      const runnable = Object.keys(attrs).filter(p=>attrs[p] && attrs[p].runnable !== false);
      if(!runnable.length){
        alert('No runnable attributes for this document.');
        return;
      }
      const payload = force ? { overwrite: true, force: true } : { force: true };
      await fetch('/api/enqueue', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({doc_ids:[doc_id], plugins: runnable, payload})
      });
      await refresh();
    }
    async function loadFailedJobs(){
      const r = await fetch('/api/queue/list?status=failed&limit=50');
      const data = await r.json();
      const items = data.items || [];
      const root = document.getElementById('failed_jobs');
      if(!items.length){ root.innerHTML = '<small>No failed jobs</small>'; return; }
      root.innerHTML = '<ul>' + items.map(i=>`<li><a href="#" onclick="viewJob(${i.id});return false;">${i.plugin} :: ${i.doc_id} (#${i.id})</a>${i.last_error?` <small class=err>${escapeHtml((i.last_error||'').slice(0,120))}</small>`:''}</li>`).join('') + '</ul>';
    }
    async function viewJob(id){
      const r = await fetch('/api/queue/job/' + id);
      if(!r.ok){ alert('Job '+id+' not found'); return; }
      const job = await r.json();
      const pre = document.createElement('pre');
      pre.style.whiteSpace = 'pre-wrap';
      pre.style.background = 'var(--panel-alt)';
      pre.style.padding = '8px';
      pre.style.borderRadius = '6px';
      pre.style.border = '1px solid var(--border)';
      pre.textContent = JSON.stringify(job, null, 2);
      const root = document.getElementById('failed_jobs');
      root.innerHTML = '';
      root.appendChild(pre);
    }
    
  </script>
</body>
</html>

